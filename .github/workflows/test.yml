name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run Tests
        env:
          RUN_ID: ${{ github.run_id }}
          TESTER: GitHub Actions
          ENVIRONMENT: CI
          APP_VERSION: ${{ github.ref == 'refs/heads/main' && '1.0.0' || 'dev' }}
          BUILD_NUMBER: ${{ github.run_number }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
        run: npm run test:registry
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_number }}
          path: |
            documentation/testing/results/*.md
          retention-days: 30
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Find the most recent test result file
            const resultsDir = 'documentation/testing/results';
            if (fs.existsSync(resultsDir)) {
              const files = fs.readdirSync(resultsDir)
                .filter(f => f.startsWith('TEST_REGISTRY_') && f.endsWith('.md'))
                .sort()
                .reverse();
              
              if (files.length > 0) {
                const resultFile = path.join(resultsDir, files[0]);
                const content = fs.readFileSync(resultFile, 'utf8');
                
                // Extract summary
                const summaryMatch = content.match(/\| \*\*TOTAL.*?\*\* \| \*\*(\d+)\*\* \| (\d+) \| (\d+) \| \d+ \| (\d+) \|/);
                if (summaryMatch) {
                  const [total, passed, failed, notRun] = summaryMatch.slice(1);
                  
                  const body = `## Test Results
                  
                  | Metric | Count |
                  |--------|-------|
                  | Total | ${total} |
                  | Passed | ${passed} |
                  | Failed | ${failed} |
                  | Not Run | ${notRun} |
                  
                  Full results: See artifact \`test-results-${{ github.run_number }}\`
                  `;
                  
                  github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: body
                  });
                }
              }
            }
